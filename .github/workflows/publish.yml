name: ðŸ“¦ Publish

on:
  workflow_dispatch:
  push:
    tags:
      - v*.*.*

jobs:
  version:
    name: Publish new version
    timeout-minutes: 5
    runs-on: self-hosted
    permissions:
      contents: write
      packages: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install
        uses: ./.github/workflows/composite

      - name: Build packages
        run: pnpm build

      - name: Set up npm auth for npmjs.org
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc

      - name: Publish packages
        run: pnpm ci:publish
        shell: bash

      - name: Send Teams notification
        run: |
          curl -H 'Content-Type: application/json' \
          -d '{
            "@type": "MessageCard",
            "@context": "http://schema.org/extensions",
            "summary": "Mixin UI Release",
            "themeColor": "0076D7",
            "title": "ðŸš€ Mixin UI ${{ github.ref_name }} has been released",
            "text": "ðŸ”— [Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})<br>ðŸ“˜ [Release Notes](https://github.com/CORETEQ/mixin-ui/releases/tag/${{ github.ref_name }})<br>ðŸ§© [Documentation](https://mixin-ui.dev)"
          }' \
          "https://coreteqsk.webhook.office.com/webhookb2/cbdc01b2-ad9e-4e37-a112-15cd29650424@42020f7a-f307-427f-bb1e-8380101218c1/IncomingWebhook/cc3bc4d9d2124e88a1661d992b6d9301/279cd2cf-fc2b-4325-8f14-50c9eeafc20b/V2HMy3Mwo0tfN38TiL7984iilhQ5qlSQ-JNWciTyiucXQ1"
